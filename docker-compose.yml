networks:
  app-net:

volumes:
  db_data:
  minio_data:
  trigger_volume:

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-booklatte}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-booklatte}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-booklatte}"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks: [app-net]

  minio:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":${MINIO_CONSOLE_PORT:-9001}"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-booklatte}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-password}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:${MINIO_CONSOLE_PORT:-9001}"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/ready || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    networks: [app-net]

  keycloak:
    image: quay.io/keycloak/keycloak:26.4.4
    container_name: keycloak_auth
    restart: unless-stopped
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-password}
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: ${POSTGRES_DB:-booklatte}
      KC_DB_USERNAME: ${POSTGRES_USER:-booklatte}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-password}
      KC_HTTP_PORT: ${KEYCLOAK_PORT:-8080}
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HEALTH_ENABLED: true
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${KEYCLOAK_PORT:-8080}:${KEYCLOAK_PORT:-8080}"
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/${KEYCLOAK_PORT:-8080} && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    networks:
      - app-net

  backend-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend_api
    restart: unless-stopped
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    env_file:
      - ./backend/.env
    environment:
      POSTGRES_HOST: postgres
      MINIO_ENDPOINT: minio:9000
      KEYCLOAK_ISSUER: http://keycloak:${KEYCLOAK_PORT:-8080}/realms/booklatte
      DB_POOL_SIZE: ${DB_POOL_SIZE:-10}
      DB_MAX_OVERFLOW: ${DB_MAX_OVERFLOW:-20}
      DB_POOL_RECYCLE: ${DB_POOL_RECYCLE:-1800}
      DB_POOL_TIMEOUT: ${DB_POOL_TIMEOUT:-30}
      TRIGGER_DIR: /app/trigger
    volumes:
      - trigger_volume:/app/trigger
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys,urllib.request; sys.exit(0) if urllib.request.urlopen('http://localhost:8000/', timeout=2).status==200 else sys.exit(1)\""]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - app-net

  observer:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: observer_service
    restart: unless-stopped
    command: python run_observer.py
    env_file:
      - ./backend/.env
    environment:
      POSTGRES_HOST: postgres
      MINIO_ENDPOINT: minio:9000
      TRIGGER_DIR: /app/trigger
    volumes:
      - trigger_volume:/app/trigger
    depends_on:
      backend-api:
        condition: service_healthy
    networks:
      - app-net

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:8000
        VITE_KEYCLOAK_URL: http://localhost:8080
        VITE_KEYCLOAK_REALM: booklatte
        VITE_KEYCLOAK_CLIENT_ID: frontend
        VITE_POWER_BI_EMBED_URL: ""
    container_name: frontend_app
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      backend-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - app-net